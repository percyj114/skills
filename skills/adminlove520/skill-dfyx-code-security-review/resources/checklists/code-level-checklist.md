# 代码层面安全检查清单

## 1. 注入攻击
- [ ] SQL注入：所有数据库查询使用参数化查询或ORM框架
- [ ] NoSQL注入：MongoDB等NoSQL数据库使用安全查询方法
- [ ] 命令注入：避免使用shell=True执行系统命令
- [ ] LDAP注入：使用参数化LDAP查询
- [ ] XPATH注入：使用安全的XPATH查询方法
- [ ] 模板注入：避免使用用户输入直接构造模板
- [ ] SSRF注入：限制服务端请求的协议和域名范围

## 2. 认证缺陷
- [ ] 弱密码策略：实施强密码要求和密码复杂度检查
- [ ] 凭证存储不安全：密码使用bcrypt等算法加密存储
- [ ] 认证绕过：实施严格的认证逻辑，避免逻辑缺陷
- [ ] 会话管理不当：设置合理的会话过期时间，使用安全的会话存储
- [ ] 多因素认证缺失：关键操作实施多因素认证
- [ ] 密码重置漏洞：安全的密码重置流程

## 3. 敏感数据暴露
- [ ] 明文存储敏感数据：敏感数据加密存储
- [ ] 传输未加密：使用HTTPS传输所有数据
- [ ] 日志泄露：确保日志中不包含敏感信息（如邮箱、密码、账号等）
- [ ] 错误消息泄露：统一错误处理，不暴露内部错误详情
- [ ] 敏感数据传输：敏感数据传输加密
- [ ] 数据备份安全：备份数据加密和访问控制

## 4. 访问控制失效
- [ ] 水平越权：用户只能访问自己的数据
- [ ] 垂直越权：严格的权限检查，避免权限提升
- [ ] CORS配置错误：正确配置CORS策略
- [ ] CSRF攻击：实施CSRF令牌保护
- [ ] 访问控制绕过：实施基于角色的访问控制
- [ ] API访问控制：API接口的访问控制

## 5. 安全配置错误
- [ ] 默认配置：修改默认密码和配置
- [ ] 过度权限：实施最小权限原则
- [ ] 错误的安全设置：正确配置安全选项
- [ ] 调试信息泄露：生产环境禁用调试模式
- [ ] 云服务配置错误：正确配置云服务安全选项
- [ ] 容器配置错误：正确配置容器安全选项

## 6. 跨站脚本(XSS)
- [ ] 存储型XSS：所有用户输入输出进行HTML转义
- [ ] 反射型XSS：URL参数和表单输入验证和转义
- [ ] DOM型XSS：客户端JavaScript安全处理用户输入
- [ ] 富文本XSS：富文本编辑器的安全配置
- [ ] 模板引擎XSS：模板引擎的安全配置

## 7. 不安全的反序列化
- [ ] 避免反序列化用户可控数据
- [ ] 使用安全的序列化格式如JSON
- [ ] 对序列化数据进行签名验证
- [ ] 反序列化数据验证：验证反序列化后的数据
- [ ] 限制反序列化类：限制可反序列化的类

## 8. 使用含有已知漏洞的组件
- [ ] 定期更新依赖库到最新安全版本
- [ ] 使用依赖扫描工具检测漏洞
- [ ] 实施软件物料清单(SBOM)管理
- [ ] 第三方组件安全评估：评估第三方组件的安全性
- [ ] 组件版本锁定：锁定依赖组件版本

## 9. 日志记录与监控不足
- [ ] 关键操作日志记录
- [ ] 安全事件监控
- [ ] 异常行为检测
- [ ] 日志完整性：确保日志不被篡改
- [ ] 日志保留：合理的日志保留策略

## 10. API安全漏洞
- [ ] 参数篡改防护
- [ ] 接口滥用防护
- [ ] 速率限制实施
- [ ] 输入验证不足
- [ ] API密钥管理：安全的API密钥管理
- [ ] API文档安全：API文档的安全管理

## 11. 密钥管理
- [ ] 密钥硬编码检查：代码中不存在硬编码的API密钥、令牌或密码
- [ ] 硬编码密码检查：代码中不存在硬编码的密码（如数据库密码、管理员密码等）
- [ ] 环境变量使用：所有密钥使用环境变量存储
- [ ] .gitignore配置：.env.local等敏感文件在.gitignore中
- [ ] Git历史检查：密钥不在Git历史中
- [ ] 托管平台配置：生产环境密钥在托管平台配置
- [ ] 密钥不存在验证：启动时验证密钥是否存在

## 12. 输入验证
- [ ] 模式验证：所有用户输入使用模式验证（如Zod、Yup等）
- [ ] 文件上传验证：文件大小、类型、扩展名限制
- [ ] 白名单验证：使用白名单而非黑名单验证
- [ ] 错误消息安全：错误消息不泄露敏感信息
- [ ] 直接使用检查：用户输入不直接用于查询

## 13. 认证与授权
- [ ] Token存储：令牌存储在httpOnly cookie中（而非localStorage）
- [ ] 授权检查：敏感操作前进行授权检查
- [ ] 行级安全：数据库行级安全策略已启用
- [ ] 基于角色的访问控制：实现基于角色的访问控制
- [ ] 会话管理：会话管理安全

## 14. CSRF防护
- [ ] CSRF令牌：状态变更操作使用CSRF令牌
- [ ] SameSite Cookie：所有cookie设置SameSite=Strict
- [ ] 双重提交Cookie模式：实现双重提交Cookie模式

## 15. 速率限制
- [ ] API速率限制：所有API端点启用速率限制
- [ ] 敏感操作限制：敏感操作使用更严格的限制
- [ ] IP限制：基于IP的速率限制
- [ ] 用户限制：基于用户的速率限制（已认证用户）

## 16. 区块链安全（如果涉及区块链）
- [ ] 钱包签名验证：验证钱包签名
- [ ] 交易详情验证：验证交易详情
- [ ] 余额检查：交易前检查余额
- [ ] 盲签名防护：不进行盲签名

## 17. 安全测试
- [ ] 认证测试：测试认证要求
- [ ] 授权测试：测试授权要求
- [ ] 输入验证测试：测试输入验证
- [ ] 速率限制测试：测试速率限制

## 18. 安全编码实践
- [ ] 不安全的随机数：使用安全的随机数生成器（如SecureRandom）
- [ ] WebShell检测：代码中不存在可疑的WebShell代码
- [ ] 远程文件包含：禁用或严格限制远程文件包含
- [ ] 回调函数安全：避免使用用户可控的回调函数
- [ ] 安全依赖：使用安全的依赖库版本
- [ ] 不安全的反射：避免使用用户可控的输入作为反射API的参数
- [ ] Java SQL注入：使用预编译语句（PreparedStatement）执行SQL查询
- [ ] Java反射型跨站脚本：使用HTML转义处理输出到客户端的数据
- [ ] Java服务器端请求伪造：使用白名单限制URL和域名
- [ ] Java CORS配置：正确配置CORS策略，避免过度宽松
- [ ] Java Cookie安全：设置HttpOnly和Secure属性
- [ ] Java错误处理：避免在生产环境暴露详细的错误信息
- [ ] Java会话管理：设置合理的会话过期时间，使用安全的会话存储
- [ ] Java资源释放：确保所有资源（如数据库连接、文件流等）正确释放
- [ ] Java权限管理：实施最小权限原则，避免过度权限
- [ ] Java JNDI注入：使用白名单限制JNDI名称，避免用户可控的lookup参数
- [ ] Java反序列化漏洞：避免反序列化用户可控数据，使用安全的序列化格式
- [ ] Java RMI漏洞：正确配置RMI安全选项，避免不安全的RMI实现
- [ ] Java SSTI：避免使用用户可控的模板参数，使用安全的模板引擎
- [ ] Java SpEL注入：避免使用用户可控的SpEL表达式，使用安全的表达式上下文
- [ ] Java JEXL注入：避免使用用户可控的JEXL表达式，使用表达式白名单
- [ ] Java MVEL注入：避免使用用户可控的MVEL表达式，使用表达式白名单
- [ ] Java OGNL注入：避免使用用户可控的OGNL表达式，使用安全的OGNL上下文
- [ ] Java Fel注入：避免使用用户可控的Fel表达式，限制表达式功能
- [ ] Java表达式注入：避免使用用户可控的表达式参数，使用安全的表达式引擎配置
- [ ] Java IDOR：实施严格的访问控制，避免直接使用用户输入作为对象引用
- [ ] Java CSRF：实施CSRF令牌保护，使用SameSite Cookie
- [ ] Java JWT安全：使用安全的JWT实现，设置合理的过期时间
- [ ] Java重定向漏洞：使用白名单限制重定向URL
- [ ] Java路径遍历：验证用户输入的文件路径，避免路径遍历攻击
- [ ] Java未授权访问：实施严格的认证和授权检查
- [ ] Java文件上传：验证文件类型、大小和内容，避免上传恶意文件
- [ ] Java DoS：实施速率限制，避免资源耗尽攻击
- [ ] Java IP伪造：验证客户端IP地址，避免IP伪造攻击
- [ ] Java CSV注入：对CSV文件中的特殊字符进行转义
- [ ] Java XPath注入：使用参数化XPath查询
- [ ] Java XXE：禁用XML外部实体，使用安全的XML解析器
- [ ] Java SQL注入：使用预处理语句（PreparedStatement）执行SQL查询
- [ ] Java命令执行：避免使用Runtime.getRuntime().exec()执行系统命令，或对输入进行严格验证
- [ ] Java反序列化：避免反序列化用户可控数据，使用安全的反序列化方法
- [ ] Java SSRF：验证用户输入的URL，限制协议和域名范围
- [ ] Java XSS：对输出到HTML页面的用户输入进行HTML转义
- [ ] Java不安全组件：使用最新版本的组件，避免使用存在已知漏洞的组件
- [ ] Java日志安全：确保日志中不包含敏感信息
- [ ] Java异常处理：避免在生产环境暴露详细的错误信息
- [ ] Java资源释放：确保所有资源（如数据库连接、文件流等）正确释放
- [ ] Java线程安全：避免并发操作导致的安全问题
- [ ] Java加密安全：使用安全的加密算法和密钥管理
- [ ] Java会话管理：设置合理的会话过期时间，使用安全的会话存储
- [ ] Java认证安全：实施强密码策略和多因素认证
- [ ] Java授权安全：实施基于角色的访问控制
- [ ] Java环境安全：正确配置JVM和应用服务器安全选项
- [ ] Java依赖安全：定期更新依赖库，使用安全的依赖版本
- [ ] Java网络安全：使用HTTPS，设置安全的HTTP头部
- [ ] Java配置安全：避免硬编码敏感信息，使用环境变量或配置文件
- [ ] Java监控安全：实施安全事件监控和日志分析
- [ ] Java备份安全：定期备份数据，确保备份数据的安全

## 19. PHP安全检查
- [ ] PHP in_array()使用：使用in_array()函数时设置第三个参数为true进行严格类型比较
- [ ] PHP filter_var()使用：使用filter_var()验证URL时，额外检查协议是否为http或https
- [ ] PHP class_exists()使用：使用class_exists()函数时设置第二个参数为false禁用自动加载
- [ ] PHP XXE防护：使用libxml_disable_entity_loader(true)禁用XML外部实体
- [ ] PHP文件上传：验证文件类型、大小和内容，避免上传恶意文件
- [ ] PHP文件包含：禁用或严格限制远程文件包含，验证包含路径
- [ ] PHP代码执行：避免使用eval()、assert()等危险函数
- [ ] PHP命令注入：避免使用shell_exec()等执行系统命令的函数，使用白名单限制
- [ ] PHP SQL注入：使用PDO或mysqli预处理语句，避免直接拼接SQL语句
- [ ] PHP XSS防护：使用htmlspecialchars()转义输出
- [ ] PHP CSRF防护：实施CSRF令牌保护
- [ ] PHP会话管理：使用session_regenerate_id()防止会话固定攻击
- [ ] PHP密码哈希：使用password_hash()和password_verify()进行密码处理
- [ ] PHP错误处理：生产环境禁用错误显示，使用日志记录
- [ ] PHP配置安全：关闭危险的PHP配置选项（如allow_url_include、register_globals等）
- [ ] PHP路径遍历：验证用户输入的文件路径，避免路径遍历攻击
- [ ] PHP反序列化：避免反序列化用户可控数据，使用JSON替代
- [ ] PHP头注入：验证和清理HTTP头信息
- [ ] PHP LDAP注入：使用参数化LDAP查询
- [ ] PHP MongoDB注入：使用安全的查询方法
- [ ] PHP Redis注入：使用参数化Redis命令
- [ ] PHP数组参数注入：验证数组参数中的每个元素类型，特别是用于SQL IN语句的参数
- [ ] PHP API参数验证：验证API接口参数，特别是包含冒号等特殊字符的参数
- [ ] PHP表单参数处理：对POST和GET参数进行类型验证和过滤
- [ ] PHP数据库操作：避免在SQL语句中直接使用用户输入，特别是在ORDER BY和GROUP BY子句中
- [ ] PHP文件路径验证：使用realpath()和strpos()验证文件路径是否在预期目录内
- [ ] PHP多参数注入：注意处理多个参数组合导致的注入漏洞
- [ ] PHP正则表达式安全：避免使用用户输入作为正则表达式模式
- [ ] PHP变量覆盖：防止用户输入覆盖服务器变量，如使用extract()函数时
- [ ] PHP远程代码执行：避免使用用户可控的回调函数，特别是call_user_func()、array_map()等函数
- [ ] PHP URL重定向：使用白名单限制重定向URL，避免开放重定向攻击
- [ ] PHP函数调用：验证用户输入的函数名，避免调用危险函数
- [ ] PHP参数验证：对所有用户输入进行严格的类型验证和过滤
- [ ] PHP代码执行防护：禁用危险函数或使用disable_functions配置选项限制函数调用
- [ ] PHP输出控制：使用ob_start()和ob_end_clean()控制输出，避免信息泄露
- [ ] PHP open_basedir配置：正确配置open_basedir限制，防止目录遍历攻击
- [ ] PHP allow_url_fopen配置：生产环境禁用allow_url_fopen，防止远程文件访问
- [ ] PHP allow_url_include配置：生产环境禁用allow_url_include，防止远程代码执行
- [ ] PHP disable_functions配置：正确配置disable_functions，禁用所有危险函数
- [ ] PHP open_basedir绕过防护：避免使用可能绕过open_basedir的函数，或对其输入进行严格验证
- [ ] PHP disable_functions绕过防护：定期更新系统和PHP版本，修复已知的disable_functions绕过漏洞

## 20. Python安全检查
- [ ] Python SQL注入：使用参数化查询或ORM框架，避免使用格式化字符串拼接SQL
- [ ] Python SSRF防护：使用白名单限制URL和域名，避免访问内网资源
- [ ] Python SSTI防护：避免使用render_template_string，使用SandboxedEnvironment
- [ ] Python XSS防护：使用模板自动转义或html.escape()手动转义
- [ ] Python反序列化：避免使用pickle反序列化用户可控数据，使用JSON替代
- [ ] Python命令执行：使用参数列表执行命令，避免shell=True
- [ ] Python文件操作：验证文件路径，避免路径遍历攻击
- [ ] Python文件读取：限制文件读取范围，避免任意文件读取
- [ ] Python文件上传：验证文件类型、大小和内容，避免上传恶意文件
- [ ] Python密码哈希：使用bcrypt或secrets模块进行密码处理
- [ ] Python会话管理：使用安全的会话存储，设置合理的过期时间
- [ ] Python环境变量：敏感信息使用环境变量存储，避免硬编码
- [ ] Python依赖安全：定期更新依赖库，使用安全的依赖版本
- [ ] Python错误处理：避免在生产环境暴露详细的错误信息
- [ ] Python配置安全：正确配置Flask/Django等框架的安全选项
- [ ] Python网络安全：使用HTTPS，设置安全的HTTP头部
- [ ] Python数据验证：使用表单验证库（如WTForms）验证用户输入
- [ ] Python日志安全：确保日志中不包含敏感信息
- [ ] Python权限管理：实施基于角色的访问控制
- [ ] Python CSRF防护：使用CSRF令牌保护，设置SameSite Cookie
- [ ] Python速率限制：实施API速率限制，防止暴力攻击
- [ ] Python CORS配置：正确配置CORS策略，避免过度宽松
- [ ] Python重定向安全：使用白名单限制重定向URL，避免开放重定向攻击
- [ ] Python DoS防护：实施速率限制，避免资源耗尽攻击
- [ ] Python IDOR防护：实施严格的访问控制，避免直接使用用户输入作为对象引用
- [ ] Python代码注入：避免使用eval()、exec()等危险函数，使用ast模块验证表达式
- [ ] Python pickle安全：避免使用pickle反序列化用户可控数据，使用JSON替代
- [ ] Python PyYAML安全：使用yaml.safe_load()替代yaml.load()
- [ ] Python模板注入：避免直接拼接模板字符串，使用模板变量
- [ ] Python沙箱安全：使用SandboxedEnvironment限制模板执行
- [ ] Python危险模块：限制subprocess、os等危险模块的使用
- [ ] Python序列化安全：使用HMAC验证序列化数据的完整性
- [ ] Python字符串格式化：避免使用用户输入作为格式化字符串的模板
- [ ] Python Flask调试模式：生产环境禁用Flask调试模式
- [ ] Python Django SECRET_KEY：保护Django SECRET_KEY，避免泄露
- [ ] Python supervisord配置：正确配置supervisord，避免远程命令执行漏洞
- [ ] Python LDAP注入：使用参数化LDAP查询，避免直接拼接LDAP语句

## 21. 代码审计方法论

### 21.1 基本审计思路
- [ ] 了解项目架构：入口点、控制器、路由配置及访问方式
- [ ] 分析鉴权方式：登录验证、权限控制等
- [ ] 检查全局过滤情况：是否封装了数据库、文件等操作并添加了校验
- [ ] 梳理模块结构：前台、后台、各功能模块的工作流
- [ ] 重点关注敏感功能：用户认证、数据处理、文件操作、系统命令执行等
- [ ] 使用关键字搜索：查找可能存在漏洞的关键函数和代码模式
- [ ] 验证输入输出：跟踪用户输入的处理流程，检查是否存在未过滤的输入

### 21.2 常见架构分析

#### 21.2.1 基于过程的架构
- [ ] 直接查找关键字和关键函数
- [ ] 分析文件间的关联关系
- [ ] 使用自动化审计工具辅助分析

#### 21.2.2 MVC架构
- [ ] 分析Model层：数据模型和数据库操作
- [ ] 分析View层：前端渲染和用户界面
- [ ] 分析Controller层：请求处理和业务逻辑
- [ ] 检查路由配置：URL映射和权限控制

### 21.3 自动化审计工具
- [ ] CodeQL：使用静态分析查询语言检测漏洞
- [ ] Kunlun-M：开源的代码审计工具
- [ ] RIPS：PHP代码审计工具
- [ ] Fortify：商业代码审计工具
- [ ] SonarQube：代码质量和安全扫描工具
- [ ] FindSecBugs：Java代码安全扫描工具
- [ ] Bandit：Python代码安全扫描工具
- [ ] Safety：Python依赖安全检查工具

### 21.4 漏洞分类审计

#### 21.4.1 注入类漏洞
- [ ] SQL注入：检查所有数据库操作，确保使用参数化查询
- [ ] NoSQL注入：检查MongoDB等NoSQL数据库操作
- [ ] 命令注入：检查系统命令执行，确保输入经过严格验证
- [ ] LDAP注入：检查LDAP查询，确保使用参数化查询
- [ ] XPATH注入：检查XPATH查询，确保使用参数化查询
- [ ] 模板注入：检查模板渲染，确保不使用用户输入直接构造模板
- [ ] SSRF注入：检查服务端请求，确保验证URL和协议

#### 21.4.2 认证与授权漏洞
- [ ] 弱密码策略：检查密码复杂度要求和密码存储方式
- [ ] 认证绕过：检查认证逻辑，确保没有逻辑缺陷
- [ ] 会话管理：检查会话创建、过期和验证机制
- [ ] 越权访问：检查权限控制，确保用户只能访问授权资源
- [ ] CSRF：检查状态变更操作，确保实施CSRF令牌保护

#### 21.4.3 敏感数据处理
- [ ] 明文存储：检查敏感数据存储方式，确保加密存储
- [ ] 传输加密：检查数据传输，确保使用HTTPS
- [ ] 日志泄露：检查日志记录，确保不包含敏感信息
- [ ] 错误处理：检查错误信息，确保不暴露内部细节

#### 21.4.4 安全配置
- [ ] 默认配置：检查默认密码和配置，确保修改为安全值
- [ ] 过度权限：检查权限设置，确保遵循最小权限原则
- [ ] 调试信息：检查生产环境配置，确保禁用调试模式
- [ ] 依赖版本：检查依赖库版本，确保使用安全版本

### 21.5 审计报告编写
- [ ] 漏洞描述：清晰描述漏洞原理和影响
- [ ] 漏洞复现：提供详细的复现步骤和PoC
- [ ] 修复建议：提供具体的修复方案和代码示例
- [ ] 风险评估：评估漏洞的严重程度和可能的影响
- [ ] 安全建议：提供整体的安全改进建议

### 21.6 持续审计
- [ ] 代码变更审计：对新增和修改的代码进行安全审计
- [ ] 依赖更新审计：定期检查依赖库的安全漏洞
- [ ] 配置变更审计：检查配置变更的安全性
- [ ] 安全事件响应：分析安全事件，改进审计方法

## 22. 安全编码实践

### 22.1 输入验证
- [ ] 对所有用户输入进行严格验证
- [ ] 使用白名单验证，避免黑名单验证
- [ ] 验证输入的类型、长度、格式和范围
- [ ] 对特殊字符进行适当的转义或编码

### 22.2 输出编码
- [ ] 对所有输出到前端的数据进行HTML转义
- [ ] 对输出到其他上下文的数据进行适当编码
- [ ] 避免直接拼接HTML、JavaScript、SQL等代码

### 22.3 安全存储
- [ ] 使用bcrypt、Argon2等安全的密码哈希算法
- [ ] 对敏感数据进行加密存储
- [ ] 避免硬编码敏感信息
- [ ] 使用安全的密钥管理方案

### 22.4 安全通信
- [ ] 使用HTTPS加密传输
- [ ] 验证SSL/TLS证书
- [ ] 避免明文传输敏感信息
- [ ] 配置安全的HTTP头部

### 22.5 安全配置
- [ ] 禁用危险的配置选项
- [ ] 启用安全的配置选项
- [ ] 遵循最小权限原则
- [ ] 定期审查和更新配置

### 22.6 安全开发流程
- [ ] 需求阶段：进行安全需求分析
- [ ] 设计阶段：进行安全设计和威胁建模
- [ ] 编码阶段：遵循安全编码规范
- [ ] 测试阶段：进行安全测试和代码审计
- [ ] 部署阶段：进行安全配置和漏洞扫描
- [ ] 维护阶段：进行安全监控和漏洞修复