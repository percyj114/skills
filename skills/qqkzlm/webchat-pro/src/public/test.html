<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Web Chat æµ‹è¯•é¡µé¢</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: #eee; }
    .log { background: #000; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #0ff; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #4a4a6a; color: #fff; border: none; border-radius: 5px; }
    button:hover { background: #5a5a7a; }
  </style>
</head>
<body>
  <h1>ğŸ§ª Web Chat v15 è¿æ¥æµ‹è¯•</h1>
  
  <div>
    <button onclick="testHealth()">1. å¥åº·æ£€æŸ¥</button>
    <button onclick="testAuth()">2. è®¤è¯æµ‹è¯•</button>
    <button onclick="testWebSocket()">3. WebSocket è¿æ¥</button>
    <button onclick="testChat()">4. å‘é€æ¶ˆæ¯</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>
  
  <h3>æ—¥å¿—:</h3>
  <div id="log" class="log"></div>
  
  <script>
    const BASE_URL = window.location.origin;
    let socket = null;
    let sessionId = 'test-' + Date.now();
    
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('log').appendChild(div);
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }
    
    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }
    
    async function testHealth() {
      log('å¼€å§‹å¥åº·æ£€æŸ¥...', 'info');
      try {
        const res = await fetch(`${BASE_URL}/api/health`);
        const data = await res.json();
        if (data.status === 'ok') {
          log(`âœ… æœåŠ¡æ­£å¸¸ (v${data.version}, sessions: ${data.sessions})`, 'success');
        } else {
          log('âŒ æœåŠ¡å¼‚å¸¸', 'error');
        }
      } catch (e) {
        log(`âŒ é”™è¯¯ï¼š${e.message}`, 'error');
      }
    }
    
    async function testAuth() {
      log('å¼€å§‹è®¤è¯æµ‹è¯•...', 'info');
      try {
        const res = await fetch(`${BASE_URL}/api/auth/check`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: 'admin123' })
        });
        const data = await res.json();
        if (data.authenticated) {
          log('âœ… è®¤è¯æˆåŠŸ', 'success');
        } else {
          log('âŒ è®¤è¯å¤±è´¥', 'error');
        }
      } catch (e) {
        log(`âŒ é”™è¯¯ï¼š${e.message}`, 'error');
      }
    }
    
    function testWebSocket() {
      log('å¼€å§‹ WebSocket è¿æ¥...', 'info');
      
      socket = io(BASE_URL);
      
      socket.on('connect', () => {
        log(`âœ… WebSocket å·²è¿æ¥ (ID: ${socket.id})`, 'success');
        socket.emit('join', sessionId);
      });
      
      socket.on('history', (messages) => {
        log(`âœ… æ”¶åˆ°å†å²è®°å½• (${messages.length}æ¡)`, 'success');
      });
      
      socket.on('session_config', (config) => {
        log(`âœ… æ”¶åˆ°ä¼šè¯é…ç½® (model: ${config.model})`, 'info');
      });
      
      socket.on('stream_chunk', (data) => {
        log(`âœ… æ”¶åˆ°æµå¼ç‰‡æ®µ: ${data.content.substring(0, 30)}...`, 'success');
      });
      
      socket.on('stream_complete', (data) => {
        log(`âœ… æ”¶åˆ°å®Œæˆæ¶ˆæ¯: ${data.content.substring(0, 50)}...`, 'success');
      });
      
      socket.on('disconnect', () => {
        log('âŒ WebSocket æ–­å¼€', 'error');
      });
      
      socket.on('connect_error', (err) => {
        log(`âŒ è¿æ¥é”™è¯¯ï¼š${err.message}`, 'error');
      });
    }
    
    async function testChat() {
      if (!socket || !socket.connected) {
        log('âŒ è¯·å…ˆè¿æ¥ WebSocket', 'error');
        return;
      }
      
      log('å¼€å§‹å‘é€æ¶ˆæ¯...', 'info');
      
      try {
        const res = await fetch(`${BASE_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: 'æµ‹è¯•æ¶ˆæ¯ï¼Œè¯·å›å¤', 
            sessionId: sessionId 
          })
        });
        const data = await res.json();
        if (data.success) {
          log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
          log('â³ ç­‰å¾… AI å›å¤...', 'info');
        } else {
          log(`âŒ å‘é€å¤±è´¥ï¼š${data.error}`, 'error');
        }
      } catch (e) {
        log(`âŒ é”™è¯¯ï¼š${e.message}`, 'error');
      }
    }
    
    // Socket.IO å®¢æˆ·ç«¯åº“ï¼ˆä»ä¸»é¡µé¢å¤åˆ¶ï¼‰
    !function(n,t){for(var e=3,r=n.createElement("canvas"),u=n.getElementsByTagName("script")[0],i=0;i<e;i++)if(n.getElementById("tsocket"+i))return;for(;i<e;i++)n.getElementById("tsocket"+i)||(r=n.createElement("script"),r.id="tsocket"+i,r.src=t,u.parentNode.insertBefore(r,u))}(document,"https://cdn.socket.io/4.8.3/socket.io.min.js");
  </script>
</body>
</html>
