#!/usr/bin/env python3
"""æ¯æ—¥ 00:00 é‡ç½® + æ—¥æŠ¥å‘é€æ¨¡å—"""

import json
import logging
from datetime import datetime, timedelta
from pathlib import Path

logger = logging.getLogger("heartbeat.daily_reset")

WORKSPACE = Path(__file__).parent.parent / "workspace"
TEMPLATES = Path(__file__).parent.parent / "templates"


def _load_daily_template() -> str:
    """åŠ è½½ daily æ¨¡æ¿"""
    path = TEMPLATES / "daily_template.md"
    if path.exists():
        return path.read_text(encoding="utf-8")
    # é»˜è®¤æ¨¡æ¿
    return (
        "# Daily Tasks | {{ date }}\n\n"
        "- [ ] æ™¨é—´é‚®ä»¶æ£€æŸ¥\n"
        "- [ ] æ›´æ–°è®°å¿†åº“\n"
        "- [ ] å·¥ä½œåŒºæ•´ç†\n"
        "- [ ] ç³»ç»ŸçŠ¶æ€ç¡®è®¤\n"
        "- [ ] æ™šé—´å›é¡¾æ€»ç»“\n"
        "- [ ] ğŸ“¡ åŒæ­¥ Canvas + FSP æ—¥ç¨‹ï¼ˆæ‰“å¼€æµè§ˆå™¨åå¿ƒè·³è‡ªåŠ¨æŠ“å–ï¼‰\n"
    )


def _collect_yesterday_summary() -> dict:
    """æ”¶é›†æ˜¨æ—¥å®Œæˆæƒ…å†µ"""
    summary = {
        "date": (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d"),
        "daily": {"done": 0, "total": 0, "items": []},
        "todo": {"completed": 0, "items": []},
        "ongoing": {"done": [], "active": []},
        "health": {"scores": [], "average": 0},
    }

    # è¯»å–å½“å‰ daily.mdï¼ˆé‡ç½®å‰ï¼‰
    daily_path = WORKSPACE / "daily.md"
    if daily_path.exists():
        import re
        content = daily_path.read_text(encoding="utf-8")
        for line in content.splitlines():
            m = re.match(r"^-\s*\[([ xX])\]\s*(.+)$", line.strip())
            if m:
                done = m.group(1).lower() == "x"
                text = m.group(2).strip()
                summary["daily"]["total"] += 1
                if done:
                    summary["daily"]["done"] += 1
                summary["daily"]["items"].append({"text": text, "done": done})

    # è¯»å– ongoing.json ä¸­å·²å®Œæˆçš„ä»»åŠ¡
    ongoing_path = WORKSPACE / "ongoing.json"
    if ongoing_path.exists():
        try:
            data = json.loads(ongoing_path.read_text(encoding="utf-8"))
            tasks = data if isinstance(data, list) else data.get("tasks", [])
            for task in tasks:
                if task.get("status") == "DONE":
                    summary["ongoing"]["done"].append(task.get("title", "?"))
                elif task.get("status") in ("WIP", "WAIT"):
                    summary["ongoing"]["active"].append(task.get("title", "?"))
        except (json.JSONDecodeError, Exception):
            pass

    # è¯»å–å¥åº·åº¦å†å²
    state_path = WORKSPACE / "state.json"
    if state_path.exists():
        try:
            state = json.loads(state_path.read_text(encoding="utf-8"))
            today_str = (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d")
            for h in state.get("health_history", []):
                if h.get("time", "").startswith(today_str):
                    summary["health"]["scores"].append(h["score"])
            if summary["health"]["scores"]:
                summary["health"]["average"] = round(
                    sum(summary["health"]["scores"]) / len(summary["health"]["scores"]), 1
                )
        except (json.JSONDecodeError, Exception):
            pass

    return summary


def generate_daily_report(summary: dict) -> str:
    """ç”Ÿæˆæ—¥æŠ¥é‚®ä»¶å†…å®¹"""
    try:
        from jinja2 import Environment, FileSystemLoader
        env = Environment(loader=FileSystemLoader(str(TEMPLATES)))
        template = env.get_template("email_review.j2")
        return template.render(summary=summary)
    except ImportError:
        logger.info("jinja2 ä¸å¯ç”¨ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ—¥æŠ¥")
    except Exception as e:
        logger.warning("æ¨¡æ¿æ¸²æŸ“å¤±è´¥ï¼Œå›é€€çº¯æ–‡æœ¬: %s", e)

    # çº¯æ–‡æœ¬å›é€€
    lines = []
    lines.append(f"ğŸ“‹ EVA æ—¥æŠ¥ | {summary['date']}")
    lines.append("=" * 40)
    lines.append("")

    # Daily
    d = summary["daily"]
    lines.append(f"## ä¾‹è¡Œä»»åŠ¡ [{d['done']}/{d['total']}]")
    for item in d["items"]:
        mark = "âœ…" if item["done"] else "âŒ"
        lines.append(f"  {mark} {item['text']}")
    lines.append("")

    # Ongoing
    o = summary["ongoing"]
    if o["done"]:
        lines.append("## å·²å®Œæˆä»»åŠ¡")
        for t in o["done"]:
            lines.append(f"  âœ… {t}")
        lines.append("")
    if o["active"]:
        lines.append("## è¿›è¡Œä¸­ä»»åŠ¡")
        for t in o["active"]:
            lines.append(f"  ğŸ”„ {t}")
        lines.append("")

    # Health
    h = summary["health"]
    if h["scores"]:
        lines.append(f"## ç³»ç»Ÿå¥åº·åº¦")
        lines.append(f"  å¹³å‡åˆ†: {h['average']}")
        lines.append(f"  å¿ƒè·³æ¬¡æ•°: {len(h['scores'])}")
        lines.append(f"  åˆ†æ•°èŒƒå›´: {min(h['scores'])} - {max(h['scores'])}")
    lines.append("")
    lines.append("---")
    lines.append("Generated by EVA Heartbeat Manager")

    return "\n".join(lines)


def reset_daily():
    """
    æ‰§è¡Œæ¯æ—¥é‡ç½®:
    1. æ”¶é›†æ˜¨æ—¥æ‘˜è¦
    2. å‘é€æ—¥æŠ¥é‚®ä»¶
    3. é‡ç½® daily.md
    4. æ¸…ç†å·²å®Œæˆçš„ ongoing ä»»åŠ¡

    è¿”å›:
        {"report_sent": bool, "daily_reset": bool, "cleanup_count": int, "error": str | None}
    """
    result = {"report_sent": False, "daily_reset": False, "cleanup_count": 0, "error": None}

    try:
        # 1. æ”¶é›†æ˜¨æ—¥æ‘˜è¦
        summary = _collect_yesterday_summary()

        # 2. ç”Ÿæˆå¹¶å‘é€æ—¥æŠ¥
        report = generate_daily_report(summary)
        from tools.mail import send_mail
        subject = f"[EVAæ—¥æŠ¥] {summary['date']} | daily:{summary['daily']['done']}/{summary['daily']['total']}"
        result["report_sent"] = send_mail(subject, report)

        # 3. é‡ç½® daily.md
        template = _load_daily_template()
        today = datetime.now().strftime("%Y-%m-%d")
        new_content = template.replace("{{ date }}", today)

        daily_path = WORKSPACE / "daily.md"
        tmp = daily_path.with_suffix(".tmp")
        tmp.write_text(new_content, encoding="utf-8")
        tmp.rename(daily_path)
        result["daily_reset"] = True
        logger.info("daily.md å·²é‡ç½®")

        # 4. æ¸…ç†å·²å®Œæˆçš„ ongoing ä»»åŠ¡ï¼ˆæ ‡è®°ä¸º DONE çš„ç§»é™¤æˆ–å½’æ¡£ï¼‰
        ongoing_path = WORKSPACE / "ongoing.json"
        if ongoing_path.exists():
            data = json.loads(ongoing_path.read_text(encoding="utf-8"))
            tasks = data if isinstance(data, list) else data.get("tasks", [])
            active_tasks = [t for t in tasks if t.get("status") != "DONE"]
            removed = len(tasks) - len(active_tasks)
            result["cleanup_count"] = removed

            if removed > 0:
                tmp = ongoing_path.with_suffix(".tmp")
                tmp.write_text(
                    json.dumps({"tasks": active_tasks}, ensure_ascii=False, indent=2),
                    encoding="utf-8",
                )
                tmp.rename(ongoing_path)
                logger.info("æ¸…ç†äº† %d ä¸ªå·²å®Œæˆ ongoing ä»»åŠ¡", removed)

        # 5. åŒæ­¥ç½‘ç«™ç›‘æ§ï¼ˆCanvas + FSP â†’ upcoming.mdï¼‰
        try:
            from tools.site_monitor import run_sync
            sync_result = run_sync()
            result["site_sync"] = sync_result
            logger.info(
                "ç½‘ç«™ç›‘æ§åŒæ­¥: +%d ~%d -%d",
                sync_result["added"], sync_result["updated"], sync_result["removed"],
            )
            if sync_result["errors"]:
                for err in sync_result["errors"]:
                    logger.warning("  åŒæ­¥é”™è¯¯: %s", err)
        except Exception as e:
            logger.warning("ç½‘ç«™ç›‘æ§åŒæ­¥å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰: %s", e)
            result["site_sync"] = {"error": str(e)}

    except Exception as e:
        result["error"] = str(e)
        logger.error("æ¯æ—¥é‡ç½®å¼‚å¸¸: %s", e)

    return result
