---
name: codex-cleaner
description: >
  Monitor and clean invalid codex auth files from CPA (Codex Provider Agent).
  Checks quota status, disables 401 files, double-verifies before deletion.
  Use when user mentions "codex clean", "clean auth", "auth files", "CPAæ¸…ç†",
  "codex è®¤è¯", "æ¸…ç†æ— æ•ˆæ–‡ä»¶", or needs to manage codex authentication files.
---

# Codex Auth File Cleaner

Clean invalid codex auth files via CPA management API. Zero dependencies (pure Python stdlib).

## First Run

Run setup wizard to configure CPA URL and admin key:

```bash
python3 scripts/codex_cleaner.py setup
```

Config saved to `config.json` (auto-created, gitignored). Config priority: CLI args > env vars (`CPA_URL`/`CPA_KEY`) > config.json.

## Commands

```bash
# View status
python3 scripts/codex_cleaner.py status
python3 scripts/codex_cleaner.py status --json

# Check active files, disable 401s
python3 scripts/codex_cleaner.py check

# Double-verify disabled files, then delete confirmed 401s
python3 scripts/codex_cleaner.py delete

# Full clean (check + delete), output human-readable report
python3 scripts/codex_cleaner.py clean --report

# Full clean, output JSON
python3 scripts/codex_cleaner.py clean --json

# Loop mode (default 300s interval)
python3 scripts/codex_cleaner.py monitor -i 300
```

## Workflow

```
clean = check + delete

check:  fetch active codex files â†’ concurrent quota check â†’ disable 401s
delete: fetch disabled files â†’ verify#1 (401?) â†’ wait 2s â†’ verify#2 (still 401?) â†’ delete
```

Double verification prevents accidental deletion of temporarily failing files.

## Nanobot Integration

For periodic monitoring, run `clean --report` via HEARTBEAT or cron, then send the stdout report to the user via `message` tool.

Example:
```bash
cd ~/.nanobot/workspace/skills/codex-cleaner && python3 scripts/codex_cleaner.py clean --report
```

## Report Format

```
ğŸ§¹ Codex è®¤è¯æ¸…ç†æŠ¥å‘Š
â° 2026-02-26 13:50:00

ğŸ“Š æ¸…ç†å‰
  æ€»è®¡: 100 | å¯ç”¨: 85 | å·²ç¦ç”¨: 15

ğŸ” æ£€æŸ¥é˜¶æ®µ
  æ£€æµ‹: 85 | å¤±æ•ˆ(401): 3 | å·²ç¦ç”¨: 3

ğŸ—‘ï¸ åˆ é™¤é˜¶æ®µ
  å¾…åˆ : 18 | éªŒè¯é€šè¿‡: 15 | å·²åˆ é™¤: 15 | è·³è¿‡: 3

ğŸ“Š æ¸…ç†å
  æ€»è®¡: 85 | âœ…å¯ç”¨: 82 | â›”å·²ç¦ç”¨: 3

âš¡ æœ¬æ¬¡æ¸…ç†: ç¦ç”¨ 3 + åˆ é™¤ 15 = 18 ä¸ªæ— æ•ˆæ–‡ä»¶
```

## Config File

`config.json` (auto-generated by setup wizard):

```json
{
  "cpa_url": "http://YOUR_CPA_HOST:PORT",
  "cpa_key": "YOUR_ADMIN_KEY",
  "concurrency": 20,
  "monitor_interval": 300,
  "notify": {
    "enabled": true,
    "channel": "telegram",
    "chat_id": "YOUR_CHAT_ID"
  }
}
```
